/**
 * SmartStore 360 - GAS API Connector
 * JSONP Version - WORKING
 */

class GASConnector {
    constructor() {
        this.baseUrl = 'https://script.google.com/macros/s/AKfycbzHuHzK0H0OI0LrwAYY7taRKBw5d7Q76Vzr0v7FY37RwssszhkeCYMYRRfijMci5iym9Q/exec';
        this.isConnected = false;
        this.callbacks = new Map();
        this.callbackId = 0;
    }

    /**
     * JSONP Request - Bypasses CORS
     */
    jsonpRequest(params = {}) {
        return new Promise((resolve, reject) => {
            const callbackName = 'gas_jsonp_' + Date.now() + '_' + this.callbackId++;
            
            // Store callback
            this.callbacks.set(callbackName, { resolve, reject });
            
            // Create global callback
            window[callbackName] = (response) => {
                this.cleanupJsonp(callbackName);
                if (response && response.status === 'success') {
                    resolve(response);
                } else {
                    reject(new Error(response?.message || 'JSONP error'));
                }
            };
            
            // Build URL
            const urlParams = new URLSearchParams({
                ...params,
                callback: callbackName,
                _: Date.now()
            });
            
            const url = `${this.baseUrl}?${urlParams}`;
            console.log('üîó JSONP URL:', url);
            
            // Create script tag
            const script = document.createElement('script');
            script.src = url;
            
            script.onerror = () => {
                this.cleanupJsonp(callbackName);
                reject(new Error('Failed to load script'));
            };
            
            // Timeout
            const timeoutId = setTimeout(() => {
                this.cleanupJsonp(callbackName);
                reject(new Error('Timeout'));
            }, 10000);
            
            this.callbacks.get(callbackName).timeoutId = timeoutId;
            
            // Inject script - THIS MAKES THE REQUEST
            document.head.appendChild(script);
        });
    }

    cleanupJsonp(callbackName) {
        const callbackInfo = this.callbacks.get(callbackName);
        if (callbackInfo?.timeoutId) {
            clearTimeout(callbackInfo.timeoutId);
        }
        delete window[callbackName];
        this.callbacks.delete(callbackName);
    }

    async testConnection() {
        console.log('üîç Testing GAS connection...');
        try {
            const response = await this.jsonpRequest({ action: 'test' });
            this.isConnected = true;
            console.log('‚úÖ GAS Connection successful:', response);
            
            // Dispatch event
            const event = new CustomEvent('gas-connected', { 
                detail: { response, timestamp: new Date() }
            });
            window.dispatchEvent(event);
            
            return response;
        } catch (error) {
            this.isConnected = false;
            console.error('‚ùå GAS Connection failed:', error);
            
            const event = new CustomEvent('gas-error', { 
                detail: { error, timestamp: new Date() }
            });
            window.dispatchEvent(event);
            
            throw error;
        }
    }

    async getProducts(category = 'all') {
        return this.jsonpRequest({ action: 'getProducts', category });
    }

    async getOrders(status = 'all') {
        return this.jsonpRequest({ action: 'getOrders', status });
    }

    async getInventory() {
        return this.jsonpRequest({ action: 'getInventory' });
    }

    async getDashboardData() {
        return this.jsonpRequest({ action: 'getDashboardData' });
    }

    async addProduct(productData) {
        return this.jsonpRequest({ action: 'addProduct', ...productData });
    }

    async createOrder(orderData) {
        return this.jsonpRequest({ action: 'createOrder', ...orderData });
    }

    getConnectionStatus() {
        return {
            isConnected: this.isConnected,
            baseUrl: this.baseUrl
        };
    }
}

// Create global instance
const gasAPI = new GASConnector();
