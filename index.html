/**
 * SmartStore 360 - JSONP Compatible Backend
 * FIXED VERSION
 */

function doGet(e) {
  return handleJsonpRequest(e);
}

function doPost(e) {
  return handleJsonpRequest(e);
}

function handleJsonpRequest(e) {
  const parameters = e.parameter;
  const callback = parameters.callback || 'callback';
  const action = parameters.action || 'test';
  
  console.log(`üì® JSONP Request - Action: ${action}`);
  
  let result;
  
  try {
    switch (action) {
      case 'test':
        result = {
          status: 'success',
          message: 'üéâ SmartStore 360 JSONP API is working!',
          version: '2.0',
          timestamp: new Date().toISOString(),
          data: {
            server: 'Google Apps Script',
            method: 'JSONP',
            cors: 'Bypassed'
          }
        };
        break;
        
      case 'getProducts':
        result = {
          status: 'success',
          products: [
            { id: 1, name: 'Wireless Headphones', price: 79.99, category: 'electronics', stock: 15 },
            { id: 2, name: 'Cotton T-Shirt', price: 19.99, category: 'clothing', stock: 50 },
            { id: 3, name: 'Water Bottle', price: 24.99, category: 'home', stock: 30 }
          ],
          total: 3,
          category: parameters.category || 'all'
        };
        break;
        
      case 'getOrders':
        result = {
          status: 'success',
          orders: [
            { id: 1001, customer: 'John Doe', total: 159.98, status: 'completed' },
            { id: 1002, customer: 'Jane Smith', total: 44.98, status: 'pending' }
          ],
          total: 2,
          status: parameters.status || 'all'
        };
        break;
        
      case 'getInventory':
        result = {
          status: 'success',
          inventory: [
            { id: 1, name: 'Wireless Headphones', stock: 15, lowStock: false },
            { id: 2, name: 'Cotton T-Shirt', stock: 50, lowStock: false },
            { id: 3, name: 'Water Bottle', stock: 2, lowStock: true }
          ],
          totalItems: 3,
          lowStockCount: 1
        };
        break;
        
      case 'getDashboardData':
        result = {
          status: 'success',
          summary: {
            totalSales: 404.96,
            totalOrders: 3,
            totalProducts: 5,
            totalCustomers: 3
          },
          recentActivity: [
            { type: 'order', message: 'New order #1002', time: '2 hours ago' },
            { type: 'stock', message: 'Water Bottle running low', time: '1 day ago' }
          ]
        };
        break;
        
      case 'addProduct':
        result = {
          status: 'success',
          message: 'Product added successfully',
          product: {
            id: Date.now(),
            name: parameters.name,
            price: parseFloat(parameters.price),
            category: parameters.category,
            stock: parseInt(parameters.stock) || 0
          }
        };
        break;
        
      case 'createOrder':
        result = {
          status: 'success',
          message: 'Order created successfully',
          order: {
            id: Date.now(),
            customer: parameters.customer,
            total: parseFloat(parameters.total),
            status: 'pending'
          }
        };
        break;
        
      default:
        result = {
          status: 'error',
          message: 'Unknown action: ' + action,
          availableActions: [
            'test', 'getProducts', 'addProduct', 'updateProduct', 'deleteProduct',
            'getOrders', 'createOrder', 'updateOrderStatus', 'getInventory',
            'updateStock', 'getSalesReport', 'getDashboardData'
          ]
        };
    }
    
  } catch (error) {
    console.error('‚ùå Backend Error:', error);
    result = {
      status: 'error',
      message: error.toString(),
      timestamp: new Date().toISOString()
    };
  }
  
  // Add timestamp if not already present
  if (!result.timestamp) {
    result.timestamp = new Date().toISOString();
  }
  
  // Return as JSONP - THIS IS CRITICAL
  const jsonpResponse = `/***/ typeof ${callback} === 'function' && ${callback}(${JSON.stringify(result)});`;
  
  return ContentService.createTextOutput(jsonpResponse)
    .setMimeType(ContentService.MimeType.JAVASCRIPT)
    .setHeader('Access-Control-Allow-Origin', '*');
}